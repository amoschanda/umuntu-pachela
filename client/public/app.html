<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Umuntu Pachela - Ride-Hailing App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --accent: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f3f4f6;
            --border: #e5e7eb;
            --text: #374151;
            --success: #10b981;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--light);
            color: var(--text);
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            background: white;
        }

        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }

        /* Main Layout */
        .main-content {
            display: flex;
            margin-top: 60px;
            height: calc(100vh - 60px);
            width: 100%;
        }

        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 1.5rem;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Auth View */
        .auth-container {
            text-align: center;
            padding: 2rem;
        }

        .auth-logo {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .role-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 2rem 0;
        }

        .role-card {
            padding: 2rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .role-card:hover {
            border-color: var(--primary);
            background: var(--light);
            transform: translateY(-2px);
        }

        .role-card.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .role-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            justify-content: center;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Cards */
        .card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .card-header {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--dark);
        }

        /* Location Section */
        .location-section {
            margin-bottom: 2rem;
        }

        .location-input {
            position: relative;
            margin-bottom: 1rem;
        }

        .location-input input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
        }

        .location-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            cursor: pointer;
        }

        .location-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .location-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background 0.2s;
        }

        .location-item:hover {
            background: var(--light);
        }

        /* Price Section */
        .price-section {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .price-display {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .price-breakdown {
            font-size: 0.875rem;
            color: var(--text);
            line-height: 1.8;
        }

        .price-breakdown-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        /* Ride Offers */
        .offer-card {
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .offer-card:hover {
            border-color: var(--primary);
            background: var(--light);
        }

        .offer-card.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .offer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .driver-name {
            font-weight: 600;
        }

        .driver-rating {
            color: var(--warning);
            font-size: 0.875rem;
        }

        .offer-price {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .offer-card.selected .offer-price {
            color: white;
        }

        .offer-details {
            font-size: 0.875rem;
            color: var(--text);
            margin-top: 0.5rem;
        }

        .offer-card.selected .offer-details {
            color: rgba(255,255,255,0.9);
        }

        /* Driver Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text);
            margin-top: 0.5rem;
        }

        /* Tracking */
        .tracking-info {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .tracking-header {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--dark);
        }

        .eta-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .driver-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .driver-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .driver-details {
            flex: 1;
        }

        .driver-name-text {
            font-weight: 600;
            color: var(--dark);
        }

        .driver-vehicle {
            font-size: 0.875rem;
            color: var(--text);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-left: 4px solid var(--primary);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 50%;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .map-container {
                height: 50%;
            }

            .role-selection {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .view.active {
            animation: fadeIn 0.3s ease;
        }

        /* Progress Indicator */
        .progress-steps {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .progress-step {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-step.active {
            background: var(--primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: var(--dark);
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 1rem;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--text);
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: var(--success);
            color: white;
        }

        .badge-warning {
            background: var(--warning);
            color: white;
        }

        .badge-danger {
            background: var(--danger);
            color: white;
        }

        /* Loading */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <i class="fas fa-motorcycle"></i>
                <span>Umuntu Pachela</span>
            </div>
            <div class="header-actions">
                <span class="user-badge" id="userBadge">Guest</span>
                <button class="btn btn-secondary btn-small" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Auth View -->
                <div id="authView" class="view active">
                    <div class="auth-container">
                        <div class="auth-logo">üèçÔ∏è</div>
                        <h1>Welcome to Umuntu Pachela</h1>
                        <p style="margin-bottom: 2rem; color: var(--text);">Choose your role to get started</p>

                        <div class="role-selection">
                            <div class="role-card" onclick="selectRole('rider')">
                                <div class="role-icon">üë§</div>
                                <div>Rider</div>
                            </div>
                            <div class="role-card" onclick="selectRole('driver')">
                                <div class="role-icon">üöó</div>
                                <div>Driver</div>
                            </div>
                        </div>

                        <div id="authForm" style="display: none;">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="fullName" placeholder="Enter your name">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="email" placeholder="Enter your email">
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="phone" placeholder="Enter your phone">
                            </div>
                            <div id="driverFields" style="display: none;">
                                <div class="form-group">
                                    <label>Vehicle Type</label>
                                    <select id="vehicleType">
                                        <option>Motorcycle</option>
                                        <option>Boda XL</option>
                                        <option>Car</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>License Plate</label>
                                    <input type="text" id="licensePlate" placeholder="Enter license plate">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="completeAuth()">Continue with Google</button>
                            <button class="btn btn-secondary" onclick="completeAuth()">Sign In</button>
                        </div>

                        <div id="roleSelected" style="display: none;">
                            <p style="margin-bottom: 1rem;">Complete your profile</p>
                            <div class="progress-steps">
                                <div class="progress-step active"></div>
                                <div class="progress-step"></div>
                                <div class="progress-step"></div>
                            </div>
                            <div id="authForm" class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="fullName" placeholder="Enter your name">
                                <label style="margin-top: 1rem;">Email</label>
                                <input type="email" id="email" placeholder="Enter your email">
                                <label style="margin-top: 1rem;">Phone</label>
                                <input type="tel" id="phone" placeholder="Enter your phone">
                                <div id="driverFields" style="display: none; margin-top: 1rem;">
                                    <label>Vehicle Type</label>
                                    <select id="vehicleType">
                                        <option>Motorcycle</option>
                                        <option>Boda XL</option>
                                        <option>Car</option>
                                    </select>
                                    <label style="margin-top: 1rem;">License Plate</label>
                                    <input type="text" id="licensePlate" placeholder="Enter license plate">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="completeAuth()">Complete Profile</button>
                        </div>
                    </div>
                </div>

                <!-- Rider View -->
                <div id="riderView" class="view">
                    <div class="location-section">
                        <div class="form-group">
                            <label><i class="fas fa-map-marker-alt"></i> Pickup Location</label>
                            <div class="location-input">
                                <input type="text" id="pickupInput" placeholder="Current location" readonly>
                                <span class="location-icon" onclick="getCurrentLocation()"><i class="fas fa-location-arrow"></i></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-map-pin"></i> Destination</label>
                            <div class="location-input">
                                <input type="text" id="destinationInput" placeholder="Where to?">
                                <span class="location-icon"><i class="fas fa-search"></i></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Ride Type</label>
                            <select id="rideType" onchange="updatePrice()">
                                <option value="boda">Boda (Motorcycle)</option>
                                <option value="bodaXL">Boda XL</option>
                                <option value="car">Car</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Schedule</label>
                            <select id="scheduleType" onchange="updatePrice()">
                                <option value="now">Now</option>
                                <option value="later">Schedule for later</option>
                            </select>
                        </div>
                    </div>

                    <div class="price-section">
                        <div class="card-header">Estimated Fare</div>
                        <div class="price-display" id="priceDisplay">$4.50</div>
                        <div class="price-breakdown">
                            <div class="price-breakdown-item">
                                <span>Base Fare:</span>
                                <span>$1.00</span>
                            </div>
                            <div class="price-breakdown-item">
                                <span>Distance (2.5 km):</span>
                                <span>$2.50</span>
                            </div>
                            <div class="price-breakdown-item">
                                <span>Time (8 min):</span>
                                <span>$1.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Your Price Offer</label>
                        <input type="number" id="userPrice" placeholder="Propose your price" step="0.50">
                    </div>

                    <button class="btn btn-primary" onclick="requestRide()">Request Ride</button>
                    <button class="btn btn-secondary" onclick="saveLocation()">Save Location</button>
                </div>

                <!-- Offers View -->
                <div id="offersView" class="view">
                    <div class="card-header">Available Drivers</div>
                    <div id="offersContainer"></div>
                    <button class="btn btn-primary" onclick="acceptOffer()">Accept Selected Offer</button>
                    <button class="btn btn-secondary" onclick="backToRider()">Back</button>
                </div>

                <!-- Tracking View -->
                <div id="trackingView" class="view">
                    <div class="tracking-info">
                        <div class="tracking-header">Your Ride</div>
                        <div class="eta-display" id="etaDisplay">5 mins away</div>
                        <div style="font-size: 0.875rem; color: var(--text); margin-bottom: 1rem;">
                            <i class="fas fa-map-marker-alt"></i> 2.5 km away
                        </div>
                        <div class="driver-info">
                            <div class="driver-avatar">üë®‚Äçüíº</div>
                            <div class="driver-details">
                                <div class="driver-name-text">John Mwangi</div>
                                <div class="driver-vehicle">Boda ‚Ä¢ KA 123 ABC</div>
                                <div style="color: var(--warning); font-size: 0.875rem;">‚≠ê 4.8 (245 rides)</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Communication</div>
                        <button class="btn btn-secondary btn-small"><i class="fas fa-phone"></i> Call Driver</button>
                        <button class="btn btn-secondary btn-small"><i class="fas fa-message"></i> Message</button>
                        <button class="btn btn-secondary btn-small"><i class="fas fa-bell"></i> Honk</button>
                    </div>

                    <div class="card">
                        <div class="card-header">Trip Details</div>
                        <div style="font-size: 0.875rem; line-height: 2;">
                            <div><strong>Pickup:</strong> Current Location</div>
                            <div><strong>Destination:</strong> Destination Address</div>
                            <div><strong>Fare:</strong> $4.50</div>
                            <div><strong>Payment:</strong> Cash</div>
                        </div>
                    </div>

                    <button class="btn btn-danger" onclick="cancelRide()">Cancel Ride</button>
                </div>

                <!-- Driver Dashboard -->
                <div id="driverView" class="view">
                    <div class="card-header">Driver Dashboard</div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">$245</div>
                            <div class="stat-label">Today's Earnings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">12</div>
                            <div class="stat-label">Rides Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">4.9</div>
                            <div class="stat-label">Rating</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">156</div>
                            <div class="stat-label">Total Rides</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Status</div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-success" onclick="toggleOnline(true)" id="onlineBtn">üü¢ Online</button>
                            <button class="btn btn-secondary" onclick="toggleOnline(false)" id="offlineBtn">‚ö´ Offline</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Incoming Requests</div>
                        <div id="rideRequestsContainer"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">Earnings Breakdown</div>
                        <div style="font-size: 0.875rem; line-height: 2;">
                            <div class="price-breakdown-item">
                                <span>This Week:</span>
                                <span>$1,245</span>
                            </div>
                            <div class="price-breakdown-item">
                                <span>This Month:</span>
                                <span>$5,320</span>
                            </div>
                            <div class="price-breakdown-item">
                                <span>Total Earnings:</span>
                                <span>$18,450</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trip History -->
                <div id="historyView" class="view">
                    <div class="card-header">Trip History</div>
                    <div id="historyContainer"></div>
                </div>
            </div>

            <!-- Map -->
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="priceNegotiationModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closePriceModal()">√ó</button>
            <div class="modal-header">Negotiate Price</div>
            <div class="form-group">
                <label>Suggested Price: <strong>$4.50</strong></label>
                <input type="number" id="negotiatedPrice" placeholder="Your offer" step="0.50" value="4.00">
            </div>
            <button class="btn btn-primary" onclick="submitPrice()">Submit Offer</button>
            <button class="btn btn-secondary" onclick="closePriceModal()">Cancel</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global State
        let appState = {
            user: null,
            role: null,
            currentLocation: { lat: -1.2921, lng: 36.8219 }, // Nairobi
            destination: null,
            selectedOffer: null,
            currentRide: null,
            isOnline: false,
            rides: [],
            drivers: [],
            map: null
        };

        // Initialize Map
        function initMap() {
            appState.map = L.map('map').setView([appState.currentLocation.lat, appState.currentLocation.lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(appState.map);

            // Add current location marker
            L.marker([appState.currentLocation.lat, appState.currentLocation.lng], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSI4IiBmaWxsPSIjMjU2M2ViIi8+PC9zdmc+',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                })
            }).addTo(appState.map).bindPopup('Your Location');

            updatePickupLocation();
        }

        // Auth Functions
        function selectRole(role) {
            appState.role = role;
            document.querySelectorAll('.role-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.role-card').classList.add('selected');

            if (role === 'driver') {
                document.getElementById('driverFields').style.display = 'block';
            } else {
                document.getElementById('driverFields').style.display = 'none';
            }

            setTimeout(() => {
                document.getElementById('authForm').style.display = 'block';
            }, 300);
        }

        function completeAuth() {
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;

            if (!fullName || !email || !phone) {
                showNotification('Please fill all fields', 'error');
                return;
            }

            appState.user = { fullName, email, phone, role: appState.role };
            document.getElementById('userBadge').textContent = fullName;

            showView(appState.role === 'rider' ? 'riderView' : 'driverView');
            showNotification('Welcome ' + fullName, 'success');
        }

        function logout() {
            appState.user = null;
            appState.role = null;
            appState.currentRide = null;
            showView('authView');
            document.getElementById('fullName').value = '';
            document.getElementById('email').value = '';
            document.getElementById('phone').value = '';
        }

        // View Management
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        // Location Functions
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    appState.currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    updatePickupLocation();
                    appState.map.setView([appState.currentLocation.lat, appState.currentLocation.lng], 13);
                    showNotification('Location updated', 'success');
                });
            }
        }

        function updatePickupLocation() {
            document.getElementById('pickupInput').value = `${appState.currentLocation.lat.toFixed(4)}, ${appState.currentLocation.lng.toFixed(4)}`;
        }

        function saveLocation() {
            showNotification('Location saved to favorites', 'success');
        }

        // Ride Functions
        function updatePrice() {
            const rideType = document.getElementById('rideType').value;
            const basePrice = rideType === 'boda' ? 4.50 : rideType === 'bodaXL' ? 6.00 : 8.00;
            document.getElementById('priceDisplay').textContent = '$' + basePrice.toFixed(2);
        }

        function requestRide() {
            const destination = document.getElementById('destinationInput').value;
            if (!destination) {
                showNotification('Please enter destination', 'error');
                return;
            }

            appState.currentRide = {
                id: 'RIDE' + Date.now(),
                status: 'searching',
                rideType: document.getElementById('rideType').value,
                destination: destination,
                fare: parseFloat(document.getElementById('priceDisplay').textContent.replace('$', ''))
            };

            generateOffers();
            showView('offersView');
            showNotification('Searching for drivers...', 'success');
        }

        function generateOffers() {
            const offers = [
                { id: 1, name: 'John Mwangi', vehicle: 'Boda', price: 4.50, rating: 4.8, rides: 245, eta: 5 },
                { id: 2, name: 'Mary Kipchoge', vehicle: 'Boda XL', price: 5.50, rating: 4.9, rides: 312, eta: 7 },
                { id: 3, name: 'Peter Kariuki', vehicle: 'Boda', price: 4.00, rating: 4.7, rides: 189, eta: 8 }
            ];

            let html = '';
            offers.forEach(offer => {
                html += `
                    <div class="offer-card" onclick="selectOffer(${offer.id}, this)">
                        <div class="offer-header">
                            <div class="driver-name">${offer.name}</div>
                            <div class="driver-rating">‚≠ê ${offer.rating}</div>
                        </div>
                        <div class="offer-details">${offer.vehicle} ‚Ä¢ ${offer.eta} mins away</div>
                        <div class="offer-price">$${offer.price.toFixed(2)}</div>
                    </div>
                `;
            });
            document.getElementById('offersContainer').innerHTML = html;
        }

        function selectOffer(offerId, element) {
            document.querySelectorAll('.offer-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            appState.selectedOffer = offerId;
        }

        function acceptOffer() {
            if (!appState.selectedOffer) {
                showNotification('Please select an offer', 'error');
                return;
            }
            appState.currentRide.status = 'accepted';
            showView('trackingView');
            showNotification('Ride accepted! Driver is on the way', 'success');
        }

        function backToRider() {
            showView('riderView');
        }

        function cancelRide() {
            appState.currentRide = null;
            showView('riderView');
            showNotification('Ride cancelled', 'success');
        }

        // Driver Functions
        function toggleOnline(online) {
            appState.isOnline = online;
            document.getElementById('onlineBtn').style.opacity = online ? '1' : '0.5';
            document.getElementById('offlineBtn').style.opacity = online ? '0.5' : '1';
            showNotification(online ? 'You are online' : 'You are offline', 'success');

            if (online) {
                generateRideRequests();
            }
        }

        function generateRideRequests() {
            const requests = [
                { id: 1, from: 'Westlands', to: 'CBD', fare: 4.50, distance: '2.5 km', time: '8 mins' },
                { id: 2, from: 'Karen', to: 'Nairobi West', fare: 6.00, distance: '4.2 km', time: '12 mins' }
            ];

            let html = '';
            requests.forEach(req => {
                html += `
                    <div class="card">
                        <div style="margin-bottom: 0.5rem;">
                            <strong>${req.from} ‚Üí ${req.to}</strong>
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text); margin-bottom: 0.5rem;">
                            ${req.distance} ‚Ä¢ ${req.time}
                        </div>
                        <div style="font-size: 1.25rem; font-weight: bold; color: var(--primary); margin-bottom: 1rem;">
                            $${req.fare.toFixed(2)}
                        </div>
                        <button class="btn btn-success btn-small" onclick="acceptRideRequest(${req.id})">Accept</button>
                        <button class="btn btn-secondary btn-small" onclick="rejectRideRequest(${req.id})">Decline</button>
                    </div>
                `;
            });
            document.getElementById('rideRequestsContainer').innerHTML = html;
        }

        function acceptRideRequest(id) {
            showNotification('Ride accepted! Heading to pickup', 'success');
        }

        function rejectRideRequest(id) {
            showNotification('Ride declined', 'success');
        }

        // Notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<strong>${type.toUpperCase()}</strong><br>${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Modal Functions
        function closePriceModal() {
            document.getElementById('priceNegotiationModal').classList.remove('active');
        }

        function submitPrice() {
            const price = document.getElementById('negotiatedPrice').value;
            showNotification(`Price offer $${price} submitted`, 'success');
            closePriceModal();
        }

        // Initialize App
        window.addEventListener('load', () => {
            initMap();
            updatePrice();
        });
    </script>
</body>
</html>
